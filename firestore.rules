
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    // Check if user is signed in and matches the requested User ID
    function isOwner(userId) {
       return request.auth != null && request.auth.uid == userId;
    }

    // Check if user is Admin (via Database Doc OR Hardcoded Email)
    function isAdmin() {
       return request.auth != null && (
          request.auth.token.email == "aayansah17@gmail.com" || 
          exists(/databases/$(database)/documents/admins/$(request.auth.uid))
       );
    }

    // --- COLLECTION RULES ---

    // 1. PROJECTS (User Saved Calculations)
    // Critical: Without this, the main Dashboard will be empty/error out.
    match /projects/{projectId} {
       allow create: if request.auth != null;
       allow read, update, delete: if isOwner(resource.data.userId);
    }

    // 2. LICENSES (Access Control)
    // Critical: Fixed "Connection Issue". Users must be able to write their own 
    // license doc for the Client-Side Fallback to work when API fails.
    match /licenses/{userId} {
       // Allow user to create/read/update their OWN license
       allow create: if isOwner(userId);
       allow read: if isOwner(userId) || isAdmin();
       allow update: if isOwner(userId) || isAdmin();
       
       // Only Admin can delete/revoke
       allow delete: if isAdmin();
    }

    // 3. LICENSE LOGS (Audit Trail)
    match /licenseLogs/{logId} {
       allow create: if request.auth != null; // Allow client to log connection attempts
       allow read: if isAdmin();
    }

    // 4. ADMINS COLLECTION
    match /admins/{adminId} {
       allow read: if isAdmin();
    }
    
    // 5. ACCESS REQUESTS (From AccessGate)
    match /access_requests/{requestId} {
       allow create: if request.auth != null;
       allow read, update: if isAdmin();
    }
  }
}
